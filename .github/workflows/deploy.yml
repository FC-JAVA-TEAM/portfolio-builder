name: Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      app_version:
        required: true
        type: string
      image_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      image_tag:
        required: true
        type: string

    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_SA_KEY:
        required: true
      GCP_REGION:
        required: true
      DOCKERHUB_USERNAME:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Log Deployment Inputs
        run: |
          echo "ğŸš€ Starting Cloud Run Deployment"
          echo "ğŸ–¼ï¸ Image Name: ${{ inputs.image_name }}"
          echo "ğŸ”– App Version: ${{ inputs.app_version }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"

      - name: Authenticate to Google Cloud
        run: |
          echo "ğŸ” Authenticating to Google Cloud..."
          echo '${{ secrets.GCP_SA_KEY }}' > gcloud-key.json
          gcloud auth activate-service-account --key-file=gcloud-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region ${{ secrets.GCP_REGION }}
          echo "âœ… Google Cloud authentication complete."

      - name: Set Cloud Run Service
        id: set-service
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            SERVICE_NAME="koodo-product-prod"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            SERVICE_NAME="koodo-product-staging"
            else
             SERVICE_NAME="koodo-product-dev"
          fi
          echo "ğŸ”§ Setting service name: $SERVICE_NAME"
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV

      - name: Confirm Deployment Settings
        run: |
          echo "ğŸ§¾ Confirming deployment settings:"
          echo "ğŸ“› Project ID: ${{ secrets.GCP_PROJECT_ID }}"
          echo "ğŸ“ Region: ${{ secrets.GCP_REGION }}"
          echo "ğŸ”§ Service Name: $SERVICE_NAME"
          echo "ğŸ–¼ï¸ Image: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.image_name }}:${{ inputs.app_version }}"

      - name: Deploy DockerHub image to Cloud Run
        run: |
          IMAGE="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.image_name }}:${{ inputs.environment }}-${{ inputs.app_version }}"
          echo "ğŸš€ Deploying image to Cloud Run..."
          echo "ğŸ” Image: $IMAGE"
          echo "âš™ï¸  Service Name: $SERVICE_NAME"
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE \
            --platform managed \
            --allow-unauthenticated \
            --quiet
          echo "âœ… Deployment complete for $SERVICE_NAME"
